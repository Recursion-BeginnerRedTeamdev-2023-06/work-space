(()=>{"use strict";class t{static BLOCK_SIZE=30;static MINO_INFO={棒形:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:"red"},正方形:{shape:[[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],color:"aqua"},S字:{shape:[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],color:"green"},Z字:{shape:[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],color:"orange"},J字:{shape:[[0,0,1,0],[0,0,1,0],[0,1,1,0],[0,0,0,0]],color:"brown"},L字:{shape:[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],color:"pink"},T字:{shape:[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],color:"silver"}};static MINO_SIZE=4;static getShapeInfo(t){return this.MINO_INFO[t]}static getRandomMinoType(){const t=["棒形","正方形","S字","Z字","J字","L字","T字"];let e=Math.floor(Math.random()*t.length);return this.MINO_INFO[t[e]]}static rotate(t){const e=t.shape;let i=[];for(let t=0;t<this.MINO_SIZE;t++){i[t]=[];for(let s=0;s<this.MINO_SIZE;s++)i[t][s]=e[this.MINO_SIZE-s-1][t]}return{shape:i,color:t.color}}}class e{constructor(){this.canvas=document.getElementById("next-mino-canvas"),this.context=this.canvas.getContext("2d"),this.canvas.height=4*t.BLOCK_SIZE,this.canvas.width=4*t.BLOCK_SIZE,this.tetro_x=0,this.tetro_y=0}static displayMino(t){(new e).drawField(t)}drawField(e){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let i=0;i<t.MINO_SIZE;i++)for(let s=0;s<t.MINO_SIZE;s++)e.shape[i][s]&&this.drawBlock(this.tetro_x+s,this.tetro_y+i,e.color)}drawBlock(e,i,s){let h=e*t.BLOCK_SIZE,o=i*t.BLOCK_SIZE;this.context.fillStyle=s,this.context.fillRect(h,o,t.BLOCK_SIZE,t.BLOCK_SIZE),this.context.strokeStyle="black",this.context.strokeRect(h,o,t.BLOCK_SIZE,t.BLOCK_SIZE)}}class i{constructor(){this.line=0,this.BASE_SCORE=100,this.BASE_BONUS=2,this.value=0}calculateScore(){return 0===this.line?this.value:1===this.line?(this.value+=this.BASE_SCORE,this.value):(this.value+=this.BASE_SCORE*this.line+this.BASE_SCORE*Math.pow(this.BASE_BONUS,this.line-1),this.value)}displayScore(){let t=document.getElementById("score-value"),e=this.calculateScore();t.textContent=e,this.value=e}}class s{constructor(e,i){this.height=e,this.width=i,this.field=[],this.canvas=document.getElementById("play-canvas"),this.context=this.canvas.getContext("2d"),this.canvas.height=t.BLOCK_SIZE*this.height,this.canvas.width=t.BLOCK_SIZE*this.width,this.canvas.style.border="4px solid #555",this.timerId=null,this.isPaused=!1,this.difficultyChanged={},this.drawGrid()}start(){if(this.isPaused)return this.isPaused=!1,void this.dropMinoLoop();this.gameSpeed=1e3,this.isGameOver=!1,this.tetro_x=this.width/2-t.MINO_SIZE/2,this.tetro_y=0,this.fieldInit(),this.currentMino=t.getRandomMinoType(),this.nextMino=t.getRandomMinoType(),this.dropMinoLoop(),e.displayMino(this.nextMino),this.score=new i,this.score.displayScore()}stop(){clearTimeout(this.timerId),this.isPaused=!0}changeDifficulty(){this.score.value>=4e3&&!this.difficultyChanged[4e3]?(this.gameSpeed*=.6,this.difficultyChanged[4e3]=!0):this.score.value>=3e3&&!this.difficultyChanged[3e3]?(this.gameSpeed*=.7,this.difficultyChanged[3e3]=!0):this.score.value>=2e3&&!this.difficultyChanged[2e3]?(this.gameSpeed*=.8,this.difficultyChanged[2e3]=!0):this.score.value>=1e3&&!this.difficultyChanged[1e3]&&(this.gameSpeed*=.9,this.difficultyChanged[1e3]=!0)}drawField(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid();for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.field[t][e]&&this.drawBlock(e,t,this.field[t][e]);for(let e=0;e<t.MINO_SIZE;e++)for(let i=0;i<t.MINO_SIZE;i++)this.currentMino.shape[e][i]&&this.drawBlock(this.tetro_x+i,this.tetro_y+e,this.currentMino.color)}fieldInit(){for(let t=0;t<this.height;t++){this.field[t]=[];for(let e=0;e<this.width;e++)this.field[t][e]=0}}drawGrid(){const e=document.getElementById("play-canvas").getContext("2d"),i=t.BLOCK_SIZE,s=this.canvas.height,h=this.canvas.width;for(let t=0;t<s;t++)for(let s=0;s<h;s++){const h=s*i,o=t*i;e.fillStyle="#221816",e.fillRect(h,o,i,i),e.strokeStyle="#ffffff",e.strokeRect(h,o,i,i)}}drawBlock(e,i,s){let h=e*t.BLOCK_SIZE,o=i*t.BLOCK_SIZE;this.context.fillStyle=s,this.context.fillRect(h,o,t.BLOCK_SIZE,t.BLOCK_SIZE),this.context.strokeStyle="black",this.context.strokeRect(h,o,t.BLOCK_SIZE,t.BLOCK_SIZE)}fixMino(){for(let e=0;e<t.MINO_SIZE;e++)for(let i=0;i<t.MINO_SIZE;i++)this.currentMino.shape[e][i]&&(this.field[this.tetro_y+e][this.tetro_x+i]=this.currentMino.color)}isContact(e,i,s){null==s&&(s=this.currentMino);for(let h=0;h<t.MINO_SIZE;h++)for(let o=0;o<t.MINO_SIZE;o++){let t=this.tetro_x+e+o,n=this.tetro_y+i+h;if(s.shape[h][o]&&(n<0||n>=this.height||this.field[n][t]||t<0||t>=this.width))return!1}return!0}dropMino(){if(!this.isGameOver){if(this.isContact(0,1))this.tetro_y++;else{const e=this.width/2-t.MINO_SIZE/2,i=0;this.fixMino(),this.currentMino=this.next_mino,this.tetro_x=e,this.tetro_y=i,this.deleteMino(),this.currentMino=this.nextMino,this.nextMino=t.getRandomMinoType(),this.isContact(0,0)||(this.isGameOver=!0)}this.drawField(),e.displayMino(this.nextMino)}}deleteMino(){let t=0;for(let e=this.height-1;e>=0;e--){let i=!0;for(let t=0;t<this.width;t++)if(!this.field[e][t]){i=!1;break}if(i){for(let t=e;t>0;t--)for(let e=0;e<this.width;e++)this.field[t][e]=this.field[t-1][e];for(let t=0;t<this.width;t++)this.field[0][t]=0;e++,t++,this.score.line=t,this.score.displayScore(),this.changeDifficulty()}}}dropMinoLoop(){this.isPaused||(this.dropMino(),this.timerId=setTimeout((()=>{this.dropMinoLoop()}),this.gameSpeed))}rotateMino(){this.currentMino=t.rotate(this.currentMino)}}let h=document.getElementById("start-retry-button"),o=document.getElementById("restart-stop-button"),n=!1;h.addEventListener("click",(function(){if(l&&l.isGameOver)return l.context.clearRect(0,0,l.canvas.width,l.canvas.height),l=null,c=null,c=new Audio,l=new s(a,r),l.start(),f(c,d),h.disabled=!0,o.disabled=!1,void u();l.start(),f(c,d),h.disabled=!0,o.disabled=!1,u()})),o.addEventListener("click",(function(){n?(l.start(),o.innerHTML="<h3>GAME<br>STOP</h3>",n=!1,c.play()):(l&&l.stop(),o.innerHTML="<h3>GAME<br>RESTART</h3>",n=!0,c.pause())})),h.disabled=!1,o.disabled=!0;const a=20,r=10;let l=new s(a,r),c=new Audio,d="Tetris.mp3";function f(t,e){t.src=`./music/${e}`,t.volume=.05,t.loop=!0,t.addEventListener("ended",(function(){t.currentTime=0,t.play()})),t.play()}function u(){l.isGameOver?(function(){let t="GAME OVER",e=l.canvas.width/2,i=l.canvas.height/2;l.context.font="40px 'MSゴシック'",l.context.lineWidth=4,l.context.textAlign="center",l.context.textBaseline="middle",l.context.strokeText(t,e,i),l.context.fillStyle="white",l.context.fillText(t,e,i)}(),l.stop(),c.pause(),h.innerHTML="<h3>GAME<br>RETRY</h3>",o.innerHTML="<h3>GAME<br>STOP</h3>",n=!1,h.disabled=!1,o.disabled=!0):requestAnimationFrame(u)}document.addEventListener("keydown",(function(e){if(!l.isGameOver&&!l.isPaused){switch(e.keyCode){case 37:l.isContact(-1,0)&&l.tetro_x--;break;case 38:for(;l.isContact(0,1);)l.tetro_y++;break;case 39:l.isContact(1,0)&&l.tetro_x++;break;case 40:l.isContact(0,1)&&l.tetro_y++;break;case 32:let e=t.rotate(l.currentMino);l.isContact(0,0,e)&&l.rotateMino()}l.drawField()}}))})();